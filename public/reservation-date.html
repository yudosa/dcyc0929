<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ ë‚ ì§œì™€ ì‹œê°„ ì„ íƒ - í¥ë•ì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="firebase-config.js"></script>
    <style>
        .ampm-tabs { display: flex; gap: 12px; margin-bottom: 18px; }
        .ampm-tab { flex: 1; padding: 10px 0; border-radius: 16px; border: none; font-weight: 700; font-size: 1.08rem; background: #f5f5f5; color: #3498db; cursor: pointer; transition: background 0.18s, color 0.18s; }
        .ampm-tab.active { background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%); color: #222; }
        .time-btn-group { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            width: 100%;
            max-width: 100%;
            justify-items: stretch;
            align-self: center;
            grid-auto-rows: auto;
            margin: 0 auto;
        }
        .time-btn { 
            min-width: 90px; 
            padding: 12px 0; 
            border-radius: 16px; 
            border: none; 
            font-size: 1.08rem; 
            font-weight: 600; 
            background: #e0e7ef; 
            color: #3498db; 
            cursor: pointer; 
            transition: background 0.18s, color 0.18s; 
            text-align: center;
            width: 100%;
            max-width: 100%;
        }
        .time-btn.selected { 
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%); 
            color: #222; 
            border: 2px solid #3498db;
            font-weight: 700;
        }
        .time-btn.disabled {
            background: #cccccc !important;
            color: #888888 !important;
            cursor: not-allowed !important;
            text-decoration: line-through !important;
            opacity: 0.5 !important;
            pointer-events: none !important;
            border: 2px solid #999999 !important;
        }
        @media (max-width: 768px) {
            .calendar-time-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .calendar-card, .time-card {
                padding: 20px;
            }
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            margin-bottom: 18px;
            width: 100%;
            text-align: center;
            flex-direction: row;
        }
        .calendar-title {
            font-size: 1.45rem;
            font-weight: 700;
            color: #222;
            letter-spacing: 1px;
            text-align: center;
            flex: 1;
        }
        .calendar-nav-btn {
            background: linear-gradient(90deg, #ffd6e3 0%, #a8edea 100%);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
            color: #ff6f61;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.10);
            cursor: pointer;
            transition: background 0.18s, color 0.18s, transform 0.18s;
        }
        .calendar-nav-btn:hover {
            background: linear-gradient(90deg, #a8edea 0%, #ffd6e3 100%);
            color: #d84315;
            transform: scale(1.08);
        }
        .reservation-calendar {
            width: 100%;
            max-width: 420px;
            border-collapse: separate;
            border-spacing: 0 12px;
            margin: 0 auto;
            align-self: center;
        }
        .reservation-calendar th {
            font-size: 1.12rem;
            color: #3498db;
            font-weight: 700;
            padding-bottom: 8px;
            text-align: center;
        }
        .reservation-calendar td {
            text-align: center;
            padding: 0;
        }
        .calendar-day {
            width: 48px;
            height: 48px;
            line-height: 48px;
            font-size: 1.18rem;
            font-weight: 600;
            border-radius: 50%;
            background: #fff;
            color: #222;
            margin: 0 auto;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            box-shadow: 0 1px 4px rgba(52, 152, 219, 0.06);
            border: 2px solid transparent;
        }
        .calendar-day.sunday {
            color: #e74c3c !important;
        }
        .calendar-day.saturday {
            color: #3498db !important;
        }
        .calendar-day.selected {
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
            color: #fff !important;
            border: 2px solid #3498db;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.13);
        }
        .calendar-day.disabled {
            background: #f0f0f0;
            color: #bbb !important;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .calendar-day:not(.selected):hover:not(.disabled) {
            background: #e0f7fa;
            color: #3498db;
            border: 2px solid #a8edea;
        }
        .reservation-detail-select {
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .rental-form-centered {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin-top: 40px !important;
        }
        .calendar-time-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            width: 100%;
            max-width: 100%;
            margin-bottom: 32px;
            margin-left: -20px;
            margin-right: auto;
        }
        .calendar-card, .time-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
            padding: 20px 8px;
            display: flex;
            flex-direction: column;
            height: 450px;
            align-items: stretch;
            justify-content: flex-start;
            margin-left: -30px;
            margin-right: auto;
        }
        .calendar-header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            flex-direction: row;
        }
        
        .time-header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            flex-direction: row;
        }
        .time-header h3 {
            color: #3498db;
            margin: 0;
            font-size: 1.18rem;
            font-weight: 800;
            text-align: center;
            width: 100%;
            display: block;
        }
        .detail-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
            padding: 32px 0 24px 0;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        .detail-label {
            font-size: 1.18rem;
            font-weight: 800;
            color: #3498db;
            margin-bottom: 18px;
            letter-spacing: 1px;
            text-align: center;
            width: 100%;
        }
        .detail-select {
            width: 100%;
            max-width: 420px;
            padding: 16px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 16px;
            font-size: 1.12rem;
            font-weight: 600;
            color: #3498db;
            background: #fff;
            cursor: pointer;
            transition: border-color 0.18s, box-shadow 0.18s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233498db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
            padding-right: 48px;
            margin: 0 auto;
            display: block;
        }
        .detail-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
    </style>
</head>
<body>
    <div class="container vertical-layout">
        <!-- ìƒë‹¨ ë°°ë„ˆ ì„¹ì…˜ -->
            <div class="banner-section">
            <div class="current-datetime"></div>
                <div class="banner-image">
                    <div class="image-slider">
                        <img src="dc1.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img active">
                        <img src="dc2.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                        <img src="dc3.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                        <img src="dc4.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                        <img src="dc5.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                        <img src="dc6.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                        <img src="dc7.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                    <img src="dc8.jpg" alt="ë™ì²œì²­ì†Œë…„ ë¬¸í™”ì˜ì§‘ ê±´ë¬¼" class="main-building-img">
                </div>
                    </div>
                    <div class="slider-dots">
                        <span class="dot active"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    <span class="dot"></span>
                    </div>
                </div>
            </div>
            <main class="rental-main">
                <div class="rental-form-centered reservation-date-form">
                    <div class="detail-card" id="detailCard" style="display:none;">
                        <div class="detail-label">ì„¸ë¶€ì„ íƒ</div>
                        <select class="detail-select" id="detailSelect">
                            <option value="">ì‹œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="calendar-time-container">
                        <div class="calendar-card">
                        <div class="calendar-header">
                            <button class="calendar-nav-btn" id="prevMonth">â—€</button>
                                <span class="calendar-title" id="calendarTitle">2024ë…„ 12ì›”</span>
                            <button class="calendar-nav-btn" id="nextMonth">â–¶</button>
                        </div>
                        <table class="reservation-calendar">
                            <thead>
                                <tr>
                                    <th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>
                        <div class="time-card" id="timeSelectBlock" style="display: block;">
                            <div class="time-header">
                                <h3 style="margin: 0;">ì‹œê°„ ì„ íƒ</h3>
                    </div>
                            <div class="time-btn-group" id="timeBtnGroup" style="display: flex; justify-content: center; align-items: center; height: 100%; min-height: 200px; grid-template-columns: none; gap: 0;">
                                <div style="text-align: center; color: #666; font-size: 1.1rem; font-weight: 600; line-height: 1.6; display: flex; flex-direction: column; align-items: center;">
                                    <div>ë¨¼ì € ì‹œì„¤ê³¼ ë‚ ì§œë¥¼</div>
                                    <div>ì„ íƒí•´ì£¼ì„¸ìš”</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions-centered" style="display:flex; flex-direction:row; gap:8px;">
                        <button class="btn-secondary-centered" onclick="window.location.href='select-facility.html'">â—€ ì´ì „</button>
                        <button class="btn-secondary-centered" onclick="proceedToNext()">ë‹¤ìŒ â–¶</button>
                    </div>
                </div>
            </main>
    </div>
    <script>
        // ìš´ì˜ì‹œê°„ ì„¤ì •
        const getTimeSlots = (dayOfWeek) => {
            if (dayOfWeek === 1) { // ì›”ìš”ì¼ íœ´ê´€
                return [];
            } else if (dayOfWeek === 0) { // ì¼ìš”ì¼ 18ì‹œê¹Œì§€
                return ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
            } else { // í™”~í†  20ì‹œê¹Œì§€
                return ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
            }
        };

        // í•œêµ­ ê³µíœ´ì¼ ë°ì´í„° (2024-2026ë…„)
        const holidays = [
            // 2024ë…„
            '2024-01-01', // ì‹ ì •
            '2024-02-09', // ì„¤ë‚  ì—°íœ´
            '2024-02-10', // ì„¤ë‚ 
            '2024-02-11', // ì„¤ë‚  ì—°íœ´
            '2024-02-12', // ì„¤ë‚  ëŒ€ì²´ê³µíœ´ì¼
            '2024-03-01', // ì‚¼ì¼ì ˆ
            '2024-04-10', // êµ­íšŒì˜ì›ì„ ê±°ì¼
            '2024-05-05', // ì–´ë¦°ì´ë‚ 
            '2024-05-06', // ì–´ë¦°ì´ë‚  ëŒ€ì²´ê³µíœ´ì¼
            '2024-05-15', // ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ 
            '2024-06-06', // í˜„ì¶©ì¼
            '2024-08-15', // ê´‘ë³µì ˆ
            '2024-09-16', // ì¶”ì„ ì—°íœ´
            '2024-09-17', // ì¶”ì„
            '2024-09-18', // ì¶”ì„ ì—°íœ´
            '2024-10-03', // ê°œì²œì ˆ
            '2024-10-09', // í•œê¸€ë‚ 
            '2024-12-25', // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
            
            // 2025ë…„
            '2025-01-01', // ì‹ ì •
            '2025-01-28', // ì„¤ë‚  ì—°íœ´
            '2025-01-29', // ì„¤ë‚ 
            '2025-01-30', // ì„¤ë‚  ì—°íœ´
            '2025-03-01', // ì‚¼ì¼ì ˆ
            '2025-05-05', // ì–´ë¦°ì´ë‚ 
            '2025-05-13', // ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ 
            '2025-06-06', // í˜„ì¶©ì¼
            '2025-08-15', // ê´‘ë³µì ˆ
            '2025-10-05', // ì¶”ì„ ì—°íœ´
            '2025-10-06', // ì¶”ì„
            '2025-10-07', // ì¶”ì„ ì—°íœ´
            '2025-10-08', // ì¶”ì„ ëŒ€ì²´ê³µíœ´ì¼
            '2025-10-03', // ê°œì²œì ˆ
            '2025-10-09', // í•œê¸€ë‚ 
            '2025-12-25', // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
            
            // 2026ë…„
            '2026-01-01', // ì‹ ì •
            '2026-02-16', // ì„¤ë‚  ì—°íœ´
            '2026-02-17', // ì„¤ë‚ 
            '2026-02-18', // ì„¤ë‚  ì—°íœ´
            '2026-03-01', // ì‚¼ì¼ì ˆ
            '2026-05-05', // ì–´ë¦°ì´ë‚ 
            '2026-05-02', // ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ 
            '2026-06-06', // í˜„ì¶©ì¼
            '2026-08-15', // ê´‘ë³µì ˆ
            '2026-09-24', // ì¶”ì„ ì—°íœ´
            '2026-09-25', // ì¶”ì„
            '2026-09-26', // ì¶”ì„ ì—°íœ´
            '2026-10-03', // ê°œì²œì ˆ
            '2026-10-09', // í•œê¸€ë‚ 
            '2026-12-25'  // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
        ];

        // ê³µíœ´ì¼ ì²´í¬ í•¨ìˆ˜
        function isHoliday(dateString) {
            return holidays.includes(dateString);
        }
        // ì‹œê°„ëŒ€ ë¶„í•  í•¨ìˆ˜
        const getTimeSlotGroups = (dayOfWeek) => {
            const slots = getTimeSlots(dayOfWeek);
            const amSlots = slots.slice(0, 4); // 09~12
            const pmSlots = slots.slice(4);   // 13~19
            return { amSlots, pmSlots };
        };

    let selectedFacility = null;
    let selectedDetail = null;
    let selectedTime = null;
    let selectedDate = null;
    let slots = [];
    let reserved = [];
    
    // ì˜ˆì•½ ë°ì´í„° (APIì—ì„œ ê°€ì ¸ì˜´)
    let reservationData = {};

    // ì˜ˆì•½ ë°ì´í„°ë¥¼ ì •í™•íˆ ë§¤ì¹­í•˜ëŠ” í•¨ìˆ˜
    function getReservedTimes(facility, detail, date) {
        // detailì´ ìƒìœ„ ì¹´í…Œê³ ë¦¬ëª…(ë‹Œí…ë„ ë“±)ì´ë©´ detailSelect.valueë¡œ ê°•ì œ
        if (facility && (facility === 'ë‹Œí…ë„' || facility === 'í”Œë ˆì´ìŠ¤í…Œì´ì…˜' || facility === 'ë…¸ë˜ë°©' || facility === 'ë³´ë“œê²Œì„')) {
            if (!detail || detail === facility) {
                detail = detailSelect.value.replace(/\s+/g, '');
            }
        }
        const detailKey = (facility === 'ë‹¤ëª©ì ì‹¤') ? '-' : detail;
        const key = facility + '||' + (detailKey || '-');
        console.log('getReservedTimes - key:', key);
        if (!reservationData || Object.keys(reservationData).length === 0) {
            return [];
        }
        if (reservationData[key] && reservationData[key][date]) {
            return reservationData[key][date];
        }
        return [];
    }

    // ì‹œì„¤ëª…ì— ë”°ë¼ ì„¸ë¶€ì„ íƒ ì˜µì…˜ ë™ì  ìƒì„±
    let facilityName = '';
    const detailCard = document.querySelector('.detail-card');
    const detailLabel = document.querySelector('.detail-label');
    const detailSelect = document.getElementById('detailSelect');

    function setDetailOptions(facility) {
        facilityName = facility || sessionStorage.getItem('selectedFacility') || '';
        console.log('setDetailOptions - facilityName:', facilityName);
        
        // ì œëª© ë™ì  ë³€ê²½
        const facilityTitle = document.getElementById('facilityTitle');
        if (facilityTitle && facilityName) {
            facilityTitle.innerHTML = `${facilityName} ì‹œì„¤ ì´ìš© ì‹ ì²­`;
        }
        
        // ë¶ ì¹´í˜ì™€ ë³´ë“œê²Œì„ì¸ ê²½ìš° ì‹œê°„ ì„ íƒ ê±´ë„ˆë›°ê¸°
        if (sessionStorage.getItem('instantReservation') === 'true') {
            detailCard.style.display = 'none';
            selectedFacility = facilityName;
            selectedDetail = '-';
            // ì¦‰ì‹œ ì˜ˆì•½ì€ ì‹œê°„ ì„ íƒ ì—†ì´ ë°”ë¡œ ì˜ˆì•½ ì™„ë£Œë¡œ ì´ë™
            proceedToReservationComplete();
            return;
        }
        
        // ë‚˜ë¨¸ì§€ ì‹œì„¤ë“¤ì€ ì„¸ë¶€ì„ íƒ í•„ìš”
        detailCard.style.display = 'block';
        let options = '';
        if (facilityName === 'ë‹Œí…ë„') {
                options = [
                    {v:'ë‹Œí…ë„1', t:'ğŸ® ë‹Œí…ë„1'},
                    {v:'ë‹Œí…ë„2', t:'ğŸ® ë‹Œí…ë„2'},
                    {v:'ë‹Œí…ë„3', t:'ğŸ® ë‹Œí…ë„3'}
                ];
            } else if (facilityName === 'í”Œë ˆì´ìŠ¤í…Œì´ì…˜') {
                options = [
                    {v:'í”Œë ˆì´ìŠ¤í…Œì´ì…˜1', t:'ğŸ•¹ï¸ í”Œë ˆì´ìŠ¤í…Œì´ì…˜1'},
                    {v:'í”Œë ˆì´ìŠ¤í…Œì´ì…˜2', t:'ğŸ•¹ï¸ í”Œë ˆì´ìŠ¤í…Œì´ì…˜2'}
                ];
            } else if (facilityName === 'ë…¸ë˜ë°©') {
                options = [
                    {v:'ë…¸ë˜ë°©1', t:'ğŸ¤ ë…¸ë˜ë°©1'},
                    {v:'ë…¸ë˜ë°©2', t:'ğŸ¤ ë…¸ë˜ë°©2'}
                ];
            } else if (facilityName === 'ì»´í“¨í„°') {
                options = [
                    {v:'ì»´í“¨í„°1', t:'ğŸ’» ì»´í“¨í„°1'},
                    {v:'ì»´í“¨í„°2', t:'ğŸ’» ì»´í“¨í„°2'},
                    {v:'Mac1', t:'ğŸ Mac1'},
                    {v:'Mac2', t:'ğŸ Mac2'}
                ];
            }
            detailSelect.innerHTML = options.map(o => `<option value="${o.v}">${o.t}</option>`).join('');
            // í•­ìƒ ì„¸ë¶€ì‹œì„¤ëª…ìœ¼ë¡œ selectedDetail í• ë‹¹
            selectedFacility = facilityName;
            selectedDetail = detailSelect.value.replace(/\s+/g, '');
            console.log('setDetailOptions - selectedFacility:', selectedFacility, 'selectedDetail:', selectedDetail);
    }

    // ì„¸ë¶€ì„ íƒ ë²„íŠ¼ í´ë¦­
    detailSelect.addEventListener('change', function() {
        selectedDetail = this.value.replace(/\s+/g, ''); // ê³µë°± ì œê±°
        console.log('detailSelect change - selectedDetail:', selectedDetail);
        selectedTime = null;
        showTimeSelect();
    });

    // ë‹¬ë ¥ ê´€ë ¨ ë³€ìˆ˜
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let today = new Date();
    today.setHours(0, 0, 0, 0);

    // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ë¡œì»¬ ì‹œê°„ëŒ€ ì‚¬ìš©)
    function formatDateToYYYYMMDD(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar() {
        updateCalendarTitle();
        generateCalendar();
        
        // ì›” ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendarTitle();
            generateCalendar();
        });
        
        document.getElementById('nextMonth').addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendarTitle();
            generateCalendar();
        });
    }

    // ë‹¬ë ¥ ì œëª© ì—…ë°ì´íŠ¸
    function updateCalendarTitle() {
        const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        document.getElementById('calendarTitle').textContent = `${currentYear}ë…„ ${monthNames[currentMonth]}`;
    }

    // ë‹¬ë ¥ ìƒì„±
    function generateCalendar() {
        const calendarBody = document.getElementById('calendarBody');
        // ì™„ì „íˆ ìƒˆë¡œìš´ tbodyë¡œ êµì²´ (ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€)
        const newCalendarBody = calendarBody.cloneNode(false); // ë‚´ìš© ì—†ì´ ë³µì œ
        calendarBody.parentNode.replaceChild(newCalendarBody, calendarBody);

        newCalendarBody.addEventListener('click', async function(e) {
            if (e.target.classList.contains('calendar-day') && !e.target.classList.contains('disabled') && e.target.textContent) {
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedDate = e.target.getAttribute('data-date');
                selectedTime = null;
                await loadReservationData();
                showTimeSelect();
            }
        });

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        let currentRow = document.createElement('tr');
        for (let i = 0; i < 42; i++) { // 6ì£¼ * 7ì¼
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);

            const dayCell = document.createElement('td');
            if (currentDate.getMonth() === currentMonth) {
                const dayNumber = currentDate.getDate();
                const dateString = formatDateToYYYYMMDD(currentDate);
                const isToday = currentDate.getTime() === today.getTime();
                const isPast = currentDate < today;
                const dayOfWeek = currentDate.getDay();

                let dayClass = 'calendar-day';
                if (isPast) dayClass += ' disabled';
                if (isToday) dayClass += ' today';
                if (dayOfWeek === 0) dayClass += ' sunday';
                if (dayOfWeek === 6) dayClass += ' saturday';
                if (dayOfWeek === 1) dayClass += ' disabled'; // ì›”ìš”ì¼ ë¹„í™œì„±í™”
                if (isHoliday(dateString)) dayClass += ' disabled holiday'; // ê³µíœ´ì¼ ë¹„í™œì„±í™”

                dayCell.innerHTML = `<div class="${dayClass}" data-date="${dateString}">${dayNumber}</div>`;
                if (isToday) {
                    dayCell.querySelector('.calendar-day').style.background = 'linear-gradient(90deg, #ffd6e3 0%, #a8edea 100%)';
                    dayCell.querySelector('.calendar-day').style.color = '#fff';
                    dayCell.querySelector('.calendar-day').style.fontWeight = '800';
                }
            }
            currentRow.appendChild(dayCell);
            if ((i + 1) % 7 === 0) {
                newCalendarBody.appendChild(currentRow);
                currentRow = document.createElement('tr');
            }
        }
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™” ì‹¤í–‰
    initCalendar();

    function showTimeSelect() {
        console.log('showTimeSelect í˜¸ì¶œë¨ - selectedFacility:', selectedFacility, 'selectedDetail:', selectedDetail, 'selectedDate:', selectedDate);
        const block = document.getElementById('timeSelectBlock');
        block.style.display = 'block';
        
        // ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”
        selectedTime = null;
        
        // ì‹œê°„ ì„ íƒ ì•ˆë‚´ í…ìŠ¤íŠ¸
        const guidanceText = '';

        block.innerHTML = `
            <div class="time-header">
                <h3 style="margin: 0;">ì„ íƒëœ ë‚ ì§œ: ${selectedDate}</h3>
            </div>
            ${guidanceText}
            <div class="time-btn-group" id="timeBtnGroup">
                ${getTimeBtnsHTML()}
            </div>
        `;
        // ì‹œê°„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ê°•í™”)
        setTimeout(() => {
            const btnGroup = document.getElementById('timeBtnGroup');
            console.log('ì‹œê°„ ë²„íŠ¼ ê·¸ë£¹ ì°¾ê¸°:', btnGroup);
            if (btnGroup) {
                // ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
                btnGroup.addEventListener('click', function(e) {
                    const btn = e.target.closest('.time-btn');
                    if (!btn || btn.classList.contains('disabled') || btn.disabled) {
                        console.log('disabledëœ ì‹œê°„ëŒ€ í´ë¦­ ì°¨ë‹¨:', btn?.getAttribute('data-time'));
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const clickedTime = btn.getAttribute('data-time');
                    console.log('ì‹œê°„ ë²„íŠ¼ í´ë¦­ë¨:', clickedTime, 'í˜„ì¬ ì„ íƒëœ ì‹œê°„:', selectedTime);
                    
                    // ëª¨ë“  ì‹œì„¤ì€ 1ì‹œê°„ ë‹¨ìœ„ ì„ íƒ (ì¤‘ë³µ ì„ íƒ ë°©ì§€)
                    document.querySelectorAll('.time-btn.selected').forEach(b => b.classList.remove('selected'));
                    selectedTime = clickedTime;
                    btn.classList.add('selected');
                    console.log('ì‹œê°„ ì„ íƒ:', selectedTime);
                    
                    // UI ê°±ì‹  (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
                    updateTimeSelectUI();
                });
            }
        }, 100); // DOM ì—…ë°ì´íŠ¸ í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    }

    // ì‹œê°„ ì„ íƒ UIë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ìƒì„± ì—†ìŒ)
    function updateTimeSelectUI() {
        const btnGroup = document.getElementById('timeBtnGroup');
        if (!btnGroup) return;
        
        // ëª¨ë“  ì‹œê°„ ë²„íŠ¼ì˜ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        const timeButtons = btnGroup.querySelectorAll('.time-btn');
        timeButtons.forEach(btn => {
            const btnTime = btn.getAttribute('data-time');
            btn.classList.remove('selected');
            
            if (selectedTime) {
                if (selectedTime.includes(',')) {
                    // ì—°ì† ì‹œê°„ ì„ íƒì¸ ê²½ìš°
                    const times = selectedTime.split(',');
                    if (times.includes(btnTime)) {
                        btn.classList.add('selected');
                    }
                } else {
                    // ë‹¨ì¼ ì‹œê°„ ì„ íƒì¸ ê²½ìš°
                    if (selectedTime === btnTime) {
                        btn.classList.add('selected');
                    }
                }
            }
        });
    }

    async function loadReservationData() {
        try {
            console.log('=== ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            const response = await fetch('/api/reservations');
            const reservations = await response.json();
            console.log('APIì—ì„œ ë°›ì€ ì›ë³¸ ì˜ˆì•½ ë°ì´í„°:', reservations);
            reservationData = {};
            reservations.forEach((reservation, index) => {
                // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
                const detailKey = (reservation.facility === 'ë‹¤ëª©ì ì‹¤') ? '-' : reservation.detail;
                const key = reservation.facility + '||' + (detailKey || '-');
                if (!reservationData[key]) reservationData[key] = {};
                if (!reservationData[key][reservation.date]) reservationData[key][reservation.date] = [];
                if (!reservation.status || reservation.status === 'active') {
                    // 30ë¶„ ë‹¨ìœ„ ì‹œì„¤ì´ë©´ 30ë¶„ ë‹¨ìœ„ë¡œ push
                    if (reservation.facility && (reservation.facility.includes('ë‹Œí…ë„') || reservation.facility.includes('í”Œë ˆì´ìŠ¤í…Œì´ì…˜'))) {
                        let [h, m] = reservation.start_time.split(':').map(Number);
                        const [endH, endM] = reservation.end_time.split(':').map(Number);
                        while (h < endH || (h === endH && m < endM)) {
                            const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                            if (!reservationData[key][reservation.date].includes(timeStr)) {
                                reservationData[key][reservation.date].push(timeStr);
                            }
                            m += 30;
                            if (m === 60) { m = 0; h += 1; }
                        }
                    } else {
                        // 1ì‹œê°„ ë‹¨ìœ„ ì˜ˆì•½ ì²˜ë¦¬
                        const startHour = parseInt(reservation.start_time.split(':')[0]);
                        const endHour = parseInt(reservation.end_time.split(':')[0]);
                        const duration = endHour - startHour;
                        
                        // 1ì‹œê°„ ë˜ëŠ” 2ì‹œê°„ ëª¨ë“  ì˜ˆì•½ì— ëŒ€í•´ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                        for (let h = startHour; h < endHour; h++) {
                            const timeStr = `${h.toString().padStart(2, '0')}:00`;
                            if (!reservationData[key][reservation.date].includes(timeStr)) {
                                reservationData[key][reservation.date].push(timeStr);
                            }
                        }
                    }
                }
            });
            console.log('ìµœì¢… ì •ë¦¬ëœ ì˜ˆì•½ ë°ì´í„°:', reservationData);
        } catch (error) {
            console.error('ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // ì‹œê°„ ìŠ¬ë¡¯ ìƒì„± í•¨ìˆ˜ ì¶”ê°€
    function getTimeSlotsForFacility(facility, detail, dayOfWeek, dateString) {
        // ê³µíœ´ì¼ì´ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜ (ìš´ì˜ ì•ˆí•¨)
        if (isHoliday(dateString)) {
            return [];
        }
        
        const timeSlots = getTimeSlots(dayOfWeek);
        
        // ëª¨ë“  ì‹œì„¤ì€ 1ì‹œê°„ ë‹¨ìœ„ë¡œ í‘œì‹œ
        return timeSlots;
    }

    // getTimeBtnsHTML í•¨ìˆ˜ ë‚´ ì‹œê°„ ìŠ¬ë¡¯ ìƒì„± ë¶€ë¶„ì„ êµì²´
    function getTimeBtnsHTML() {
        console.log('getTimeBtnsHTML - facilityName:', selectedFacility, 'selectedDetail:', selectedDetail, 'selectedDate:', selectedDate);
        const selectedDateObj = new Date(selectedDate);
        const dayOfWeek = selectedDateObj.getDay();
        const slots = getTimeSlotsForFacility(selectedFacility, selectedDetail, dayOfWeek, selectedDate);
        console.log('getTimeBtnsHTML - slots:', slots);
        const reserved = Object.keys(reservationData).length > 0 ? 
            getReservedTimes(selectedFacility, selectedDetail, selectedDate) : [];
        console.log('getTimeBtnsHTML - reserved:', reserved);
        
        if (!slots || slots.length === 0) {
            console.error('ì‹œê°„ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤!');
            return '<div style="text-align: center; color: #666; padding: 20px;">ì‹œê°„ ìŠ¬ë¡¯ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        let html = '<div style="text-align: center; margin-bottom: 15px;"><button onclick="checkReservationsAndShowTimeSelect(true)" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">ğŸ”„ ì˜ˆì•½ í˜„í™© ìƒˆë¡œê³ ì¹¨</button></div>';
        slots.forEach(time => {
            const paddedTime = time.padStart(5, '0');
            const isReserved = reserved.map(t => t.padStart(5, '0')).includes(paddedTime);
            let isPastTime = false;
            if (selectedDate === formatDateToYYYYMMDD(today)) {
                const [hour, minute] = time.split(':').map(Number);
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                // ì‹œì‘ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ì„ ì§€ë‚¬ìœ¼ë©´ ë¹„í™œì„±í™” (ì´ì „ ë¡œì§: ì¢…ë£Œ ì‹œê°„ ê¸°ì¤€)
                if (hour < currentHour || (hour === currentHour && minute < currentMinute)) {
                    isPastTime = true;
                }
            }
            const isDisabled = isReserved || isPastTime;
            const disabledText = isReserved ? ' (ì˜ˆì•½ë¨)' : '';
            const durationText = '';
            let buttonClass = 'time-btn';
            if (isDisabled) buttonClass += ' disabled';
            if (selectedTime === time) buttonClass += ' selected';
            let buttonHtml = `<button class="${buttonClass}" data-time="${time}"`;
            if (isDisabled) buttonHtml += ' disabled';
            buttonHtml += `>${time}${durationText}${disabledText}</button>`;
            html += buttonHtml;
        });
        return html;
    }

    // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ë™ì‘
    const actions = document.querySelector('.form-actions-centered');
    if (actions) {
        const [prevBtn, nextBtn] = actions.querySelectorAll('button');
        prevBtn.onclick = function(e) {
            e.preventDefault();
            window.location.href = 'select-facility.html';
        };
        nextBtn.onclick = function(e) {
            e.preventDefault();
            
            console.log('ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ - ì„ íƒëœ í•­ëª©ë“¤:'); // ë””ë²„ê¹…
            console.log('ì‹œì„¤:', selectedFacility);
            console.log('ì„¸ë¶€ì„ íƒ:', selectedDetail);
            console.log('ë‚ ì§œ:', selectedDate);
            console.log('ì‹œê°„:', selectedTime);
            
            // ìœ íš¨ì„± ê²€ì‚¬
            let needDetail = true;
            let detailValue = selectedDetail;
            // detailValueê°€ ìƒìœ„ ì¹´í…Œê³ ë¦¬ëª…ì¼ ê²½ìš° detailSelect.valueë¡œ ê°•ì œ, ê³µë°± ì œê±°
            if (needDetail && (!detailValue || detailValue === selectedFacility)) {
                detailValue = detailSelect.value.replace(/\s+/g, '');
            }
            
            if (needDetail && !detailValue) {
                showModal('ì„¸ë¶€ì„ íƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedDate) {
                showModal('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedTime) {
                showModal('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì„ íƒí•œ ì‹œê°„ì´ ì˜ˆì•½ ê°€ëŠ¥í•œì§€ ìµœì¢… ì²´í¬
            const reservedTimes = getReservedTimes(selectedFacility, detailValue, selectedDate);
            if (reservedTimes.includes(selectedTime)) {
                // ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ì´ë©´ ë¬´ì‹œí•˜ê³  ë¦¬í„´
                return;
            }
            
            // ì˜ˆì•½ ë°ì´í„° ì¤€ë¹„
            const userName = localStorage.getItem('userName') || 'ê³ ê°';
            const userPhone = localStorage.getItem('userPhone') || '';
            
            const userGender = localStorage.getItem('userGender') || '';
            const userAge = localStorage.getItem('userAge') || '';
            
            // ì‹œì‘ ì‹œê°„ì€ ì„ íƒëœ ì‹œê°„
            let startTime = selectedTime;
            
            const reservationData = {
                name: userName,
                phone: userPhone || undefined,
                facility: selectedFacility,
                detail: detailValue || '-',
                date: selectedDate,
                start_time: startTime,
                end_time: getEndTime(selectedTime),
                purpose: '',
                gender: userGender,
                age: userAge,
                agreedPersonalInfo: sessionStorage.getItem('agreedPersonalInfo') === 'y' ? 'ë™ì˜' : 'ë¯¸ë™ì˜'
            };
            
            console.log('ì˜ˆì•½ ë°ì´í„°:', reservationData); // ë””ë²„ê¹…
            
            // ì˜ˆì•½ API í˜¸ì¶œ
            createReservation(reservationData);
        };
    }

    // ì¢…ë£Œ ì‹œê°„ ê³„ì‚° (1ì‹œê°„ í›„)
    function getEndTime(timeSelection) {
        const [hour, minute] = timeSelection.split(':').map(Number);
        return `${(hour + 1).toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    }
    
    // ììœ¨ì´ìš© ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬
    function proceedToReservationComplete() {
        const userName = localStorage.getItem('userName') || 'ê³ ê°';
        const userPhone = localStorage.getItem('userPhone') || '';
        const userGender = localStorage.getItem('userGender') || '';
        const userAge = localStorage.getItem('userAge') || '';
        const selectedDetail = sessionStorage.getItem('selectedDetail') || 'ê¸°íƒ€';
        
        const reservationData = {
            name: userName,
            phone: userPhone || undefined,
            gender: userGender || undefined,
            age: userAge || undefined,
            facility: 'ììœ¨ì´ìš©',
            detail: selectedDetail,
            date: new Date().toISOString().split('T')[0], // ì˜¤ëŠ˜ ë‚ ì§œ
            start_time: '00:00',
            end_time: '00:01',
            status: 'active'
        };
        
        console.log('ììœ¨ì´ìš© ì˜ˆì•½ ìƒì„± ì‹œì‘:', reservationData);
        createReservation(reservationData);
    }
    
    // ì˜ˆì•½ ìƒì„± API í˜¸ì¶œ (ì‹¤ì‹œê°„ ì¤‘ë³µ ì²´í¬ í¬í•¨)
    async function createReservation(data) {
        try {
            // detail ì—†ëŠ” ì‹œì„¤ì€ '-'ë¡œ í†µì¼
            if (data.facility === 'ë‹¤ëª©ì ì‹¤') {
                data.detail = '-';
            }
            
            // ì˜ˆì•½ ìš”ì²­ ì „ ìµœì‹  ë°ì´í„°ë¡œ í•œ ë²ˆ ë” ì¤‘ë³µ ì²´í¬
            console.log('ì˜ˆì•½ ì „ ìµœì¢… ì¤‘ë³µ ì²´í¬ ì‹œì‘...');
            const dateCheckResponse = await fetch(`/api/reservations/date/${data.date}`);
            if (dateCheckResponse.ok) {
                const latestReservations = await dateCheckResponse.json();
                const conflictingReservation = latestReservations.find(reservation => {
                    if (reservation.status !== 'active') return false;
                    if (reservation.facility !== data.facility || reservation.detail !== data.detail) {
                        return false;
                    }
                    // ì‹œê°„ ê²¹ì¹¨ ì²´í¬
                    const existingStart = reservation.start_time;
                    const existingEnd = reservation.end_time;
                    const newStart = data.start_time;
                    const newEnd = data.end_time;
                    
                    return (newStart < existingEnd && newEnd > existingStart);
                });
                
                if (conflictingReservation) {
                    console.log('ìµœì¢… ì²´í¬ì—ì„œ ì¤‘ë³µ ì˜ˆì•½ ë°œê²¬:', conflictingReservation);
                    showModal('ì£„ì†¡í•©ë‹ˆë‹¤. ë°©ê¸ˆ ë‹¤ë¥¸ ë¶„ì´ í•´ë‹¹ ì‹œê°„ì„ ì˜ˆì•½í•˜ì…¨ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    // ì˜ˆì•½ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await loadReservationData();
                    showTimeSelect(); // ì‹œê°„ ì„ íƒ UI ë‹¤ì‹œ í‘œì‹œ
                    return;
                }
            }
            
            console.log('ì˜ˆì•½ ìš”ì²­ ë°ì´í„°:', data);
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            console.log('ì„œë²„ ì‘ë‹µ:', result);
            if (!response.ok) {
                console.error('ì˜ˆì•½ ì‹¤íŒ¨ ìƒì„¸:', {
                    status: response.status,
                    statusText: response.statusText,
                    error: result.error,
                    data: data
                });
                
                // ì¤‘ë³µ ì˜ˆì•½ ì—ëŸ¬ì˜ ê²½ìš° ë” ì¹œí™”ì ì¸ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = result.error || `ì˜ˆì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (${response.status})`;
                if (errorMessage.includes('í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤')) {
                    errorMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤. ë°©ê¸ˆ ë‹¤ë¥¸ ë¶„ì´ í•´ë‹¹ ì‹œê°„ì„ ì˜ˆì•½í•˜ì…¨ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.';
                    // ì˜ˆì•½ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await loadReservationData();
                    showTimeSelect(); // ì‹œê°„ ì„ íƒ UI ë‹¤ì‹œ í‘œì‹œ
                }
                
                showModal(errorMessage);
                return;
            }
            localStorage.setItem('reservationFacility', data.facility);
            localStorage.setItem('reservationDetail', data.detail);
            localStorage.setItem('reservationDate', data.date);
            localStorage.setItem('reservationTime', data.start_time);
            localStorage.setItem('reservationId', result.id);
            window.location.href = 'reservation-complete.html';
        } catch (error) {
            console.error('ì˜ˆì•½ ìƒì„± ì˜¤ë¥˜:', error);
            showModal('ì˜ˆì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê°„ë‹¨í•œ ëª¨ë‹¬ í•¨ìˆ˜ ì¶”ê°€ (ê°œì„ ëœ ë²„ì „)
    function showModal(msg) {
        let modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.left = 0;
        modal.style.top = 0;
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.35)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = 9999;
        
        // ë©”ì‹œì§€ì— ì¤„ë°”ê¿ˆì´ ìˆìœ¼ë©´ <br>ë¡œ ë³€í™˜
        const formattedMsg = msg.replace(/\n/g, '<br>');
        
        modal.innerHTML = `<div style="background:#fff;padding:32px 28px;border-radius:18px;box-shadow:0 4px 24px #3498db22;font-size:1.15rem;font-weight:600;color:#3498db;text-align:center;min-width:220px;max-width:90vw;">${formattedMsg}<br><br><button style='margin-top:18px;padding:10px 28px;border-radius:12px;background:linear-gradient(90deg,#a8edea,#fed6e3);border:none;font-weight:700;font-size:1.08rem;color:#222;cursor:pointer;' onclick='this.parentElement.parentElement.remove()'>í™•ì¸</button></div>`;
        document.body.appendChild(modal);
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œì—ë„ ë‹«ê¸°
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // ì˜ˆì•½ ë°ì´í„° í™•ì¸ í›„ ì‹œê°„ ì„ íƒ UI í‘œì‹œ (ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ í¬í•¨)
    async function checkReservationsAndShowTimeSelect(forceRefresh = false) {
        console.log('=== checkReservationsAndShowTimeSelect í•¨ìˆ˜ í˜¸ì¶œ ==='); // ë””ë²„ê¹… ì¶”ê°€
        console.log('selectedDate:', selectedDate); // ë””ë²„ê¹… ì¶”ê°€
        console.log('í˜„ì¬ ì˜ˆì•½ ë°ì´í„° í‚¤ ê°œìˆ˜:', Object.keys(reservationData).length); // ë””ë²„ê¹… ì¶”ê°€
        console.log('forceRefresh:', forceRefresh); // ë””ë²„ê¹… ì¶”ê°€
        
        // ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ìš”ì²­ë˜ì—ˆê±°ë‚˜ ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë‹¤ì‹œ ë¡œë“œ
        if (forceRefresh || Object.keys(reservationData).length === 0) {
            console.log('ì˜ˆì•½ ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); // ë””ë²„ê¹… ì¶”ê°€
            await loadReservationData();
        }
        
        console.log('showTimeSelect í•¨ìˆ˜ í˜¸ì¶œ'); // ë””ë²„ê¹… ì¶”ê°€
        showTimeSelect();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem('agreedPersonalInfo') !== 'y') {
            alert('ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            window.location.href = 'rental.html';
            return;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒëœ ì‹œì„¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const selectedFacilityFromStorage = sessionStorage.getItem('selectedFacility');
        console.log('í˜ì´ì§€ ë¡œë“œ - selectedFacilityFromStorage:', selectedFacilityFromStorage);
        
        if (selectedFacilityFromStorage) {
            setDetailOptions(selectedFacilityFromStorage);
        } else {
            // ì‹œì„¤ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
            alert('ì‹œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            window.location.href = 'select-facility.html';
            return;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜ˆì•½ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        loadReservationData();
    });
    </script>
    
    <script>
    // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ê¸°ëŠ¥
    let currentSlideIndex = 0;
    const slides = document.querySelectorAll('.image-slider .main-building-img');
    const dots = document.querySelectorAll('.dot');

    function showSlide(index) {
        // ëª¨ë“  ìŠ¬ë¼ì´ë“œ ìˆ¨ê¸°ê¸°
        slides.forEach(slide => slide.classList.remove('active'));
        dots.forEach(dot => dot.classList.remove('active'));
        
        // í˜„ì¬ ìŠ¬ë¼ì´ë“œ ë³´ì´ê¸°
        slides[index].classList.add('active');
        dots[index].classList.add('active');
    }

    function nextSlide() {
        currentSlideIndex = (currentSlideIndex + 1) % slides.length;
        showSlide(currentSlideIndex);
    }

    // ë„íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            currentSlideIndex = index;
            showSlide(currentSlideIndex);
        });
    });

    // ìë™ ìŠ¬ë¼ì´ë“œ (3ì´ˆë§ˆë‹¤)
    setInterval(nextSlide, 3000);

    // ì´ˆê¸° ìŠ¬ë¼ì´ë“œ ì„¤ì •
    showSlide(0);

    // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ëŠ” í•¨ìˆ˜
    function proceedToNext() {
        if (!selectedFacility) {
            alert('ì‹œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!selectedDate) {
            alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!selectedTime) {
            alert('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ì˜ˆì•½ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        const reservationInfo = {
            facility: selectedFacility,
            detail: selectedDetail,
            date: selectedDate,
            time: selectedTime
        };
        
        sessionStorage.setItem('reservationInfo', JSON.stringify(reservationInfo));
        alert('ì˜ˆì•½ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ì˜ˆ: reservation-complete.html)
        // window.location.href = 'reservation-complete.html';
    }
    </script>
    <style>
    /* ë‹¬ë ¥ê³¼ ì‹œê°„ëŒ€ ê°•ì œ í‘œì‹œ */
    .reservation-calendar-block {
        display: block !important;
        margin: 20px 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    .reservation-calendar {
        width: 100% !important;
        border-collapse: separate !important;
        border-spacing: 0 12px !important;
        margin: 0 auto !important;
        display: table !important;
    }
    .time-select-block {
        display: block !important;
        margin: 20px 0 !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    .calendar-day {
        width: 48px !important;
        height: 48px !important;
        line-height: 48px !important;
        text-align: center !important;
        cursor: pointer !important;
        border-radius: 50% !important;
        background: #fff !important;
        color: #222 !important;
        margin: 0 auto !important;
        display: block !important;
        font-size: 1.18rem !important;
        font-weight: 600 !important;
        border: 2px solid transparent !important;
        box-shadow: 0 1px 4px rgba(52, 152, 219, 0.06) !important;
    }
    .calendar-day:hover:not(.disabled) {
        background: #e0f7fa !important;
        color: #3498db !important;
        border: 2px solid #a8edea !important;
    }
    .calendar-day.selected {
        background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%) !important;
        color: #fff !important;
        border: 2px solid #3498db !important;
        box-shadow: 0 4px 16px rgba(52, 152, 219, 0.13) !important;
    }
    .calendar-day.disabled {
        background: #f0f0f0 !important;
        color: #bbb !important;
        cursor: not-allowed !important;
        text-decoration: line-through !important;
    }
    .calendar-day.sunday {
        color: #e74c3c !important;
    }
    .calendar-day.saturday {
        color: #3498db !important;
    }
    
    /* ì‹œê³„ ìŠ¤íƒ€ì¼ */
    .current-datetime {
        position: absolute;
        top: 16px;
        right: 18px;
        font-size: 1.32rem;
        font-weight: 700;
        color: #444;
        margin: 0;
        letter-spacing: 1px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: rgba(255,255,255,0.85);
        padding: 2px 10px;
        border-radius: 8px;
    }
    @media (max-width: 600px) {
        .current-datetime {
            text-align: center;
            margin-right: 0;
        }
    }
    </style>
    
    <script>
    // í˜„ì¬ ì‹œê°„/ë‚ ì§œ í‘œì‹œ - ë””ì§€í„¸ ì‹œê³„ ìŠ¤íƒ€ì¼
    function updateDateTime() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,'0');
        const d = String(now.getDate()).padStart(2,'0');
        const h = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        const s = String(now.getSeconds()).padStart(2,'0');
        
        // ìš”ì¼ ë°°ì—´
        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const weekday = weekdays[now.getDay()];
        
        // ë””ì§€í„¸ ì‹œê³„ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
        document.querySelector('.current-datetime').innerHTML = 
            `<div style="font-size: 1rem; margin-bottom: 2px; opacity: 0.9;">${y}-${m}-${d} (${weekday})</div>
             <div style="font-size: 1.5rem; font-weight: 800;">${h}:${min}:${s}</div>`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
    </script>
    
</body>
</html> 